/**
 * Test Script for Push Notifications
 *
 * This script helps you test the notification system
 * Run: npm test
 */

import dotenv from 'dotenv';
import { initializeFirebase } from '../config/firebase.js';
import {
  sendNotificationToUser,
  sendNotificationToAllUsers,
  isValidExpoPushToken
} from './sendNotification.js';

// Load environment
dotenv.config();

// Initialize Firebase
try {
  initializeFirebase();
  console.log('âœ… Firebase initialized for testing\n');
} catch (error) {
  console.error('âŒ Failed to initialize Firebase:', error.message);
  process.exit(1);
}

/**
 * Test menu
 */
async function main() {
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘                                                        â•‘');
  console.log('â•‘        ğŸ§ª Push Notification Test Script ğŸ§ª           â•‘');
  console.log('â•‘                                                        â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  console.log('Available Tests:\n');
  console.log('1. Test token validation');
  console.log('2. Send test notification to specific user');
  console.log('3. Send test notification to all users');
  console.log('4. Test auto-generated message for user\n');

  // For automated testing, run all tests
  await testTokenValidation();
  console.log('\n' + '='.repeat(60) + '\n');

  // Add your test user ID here
  const TEST_USER_ID = 'your-test-user-id'; // Replace with actual user ID

  console.log('âš ï¸  To test actual notifications:');
  console.log(`   1. Replace TEST_USER_ID in this file with a real user ID`);
  console.log(`   2. Make sure the user has a valid push token saved`);
  console.log(`   3. Uncomment the test functions below\n`);

  // Uncomment these to test actual notifications
  // await testUserNotification(TEST_USER_ID);
  // await testAutoGeneratedMessage(TEST_USER_ID);
  // await testAllUsersNotification();

  console.log('âœ… Testing complete!\n');
  process.exit(0);
}

/**
 * Test 1: Token Validation
 */
async function testTokenValidation() {
  console.log('ğŸ“‹ Test 1: Token Validation\n');

  const validToken = 'ExponentPushToken[xxxxxxxxxxxxxxxxxxxxxx]';
  const invalidToken1 = 'InvalidToken123';
  const invalidToken2 = 'FCMToken:12345';

  console.log(`Valid token: ${validToken}`);
  console.log(`Is valid? ${isValidExpoPushToken(validToken) ? 'âœ… Yes' : 'âŒ No'}\n`);

  console.log(`Invalid token 1: ${invalidToken1}`);
  console.log(`Is valid? ${isValidExpoPushToken(invalidToken1) ? 'âœ… Yes' : 'âŒ No'}\n`);

  console.log(`Invalid token 2: ${invalidToken2}`);
  console.log(`Is valid? ${isValidExpoPushToken(invalidToken2) ? 'âœ… Yes' : 'âŒ No'}\n`);
}

/**
 * Test 2: Send notification to specific user
 */
async function testUserNotification(userId) {
  console.log('ğŸ“‹ Test 2: Send Notification to Specific User\n');

  const customMessage = {
    title: 'ğŸ§ª Test Notification',
    body: 'This is a test notification from the backend!',
    data: {
      type: 'test',
      timestamp: new Date().toISOString()
    }
  };

  console.log(`Sending to user: ${userId}`);
  console.log(`Message:`, customMessage, '\n');

  const result = await sendNotificationToUser(userId, customMessage);

  console.log('Result:', JSON.stringify(result, null, 2), '\n');

  if (result.success) {
    console.log('âœ… Notification sent successfully!');
  } else {
    console.log('âŒ Failed to send notification:', result.message || result.error);
  }
}

/**
 * Test 3: Auto-generated message
 */
async function testAutoGeneratedMessage(userId) {
  console.log('ğŸ“‹ Test 3: Auto-Generated Message for User\n');

  console.log(`Generating personalized message for user: ${userId}`);
  console.log('This will fetch timetable and attendance data...\n');

  const result = await sendNotificationToUser(userId, null); // null = auto-generate

  console.log('Result:', JSON.stringify(result, null, 2), '\n');

  if (result.success) {
    console.log('âœ… Auto-generated notification sent successfully!');
  } else {
    console.log('âŒ Failed to send notification:', result.message || result.error);
  }
}

/**
 * Test 4: Send to all users
 */
async function testAllUsersNotification() {
  console.log('ğŸ“‹ Test 4: Send Notification to All Users\n');

  const customMessage = {
    title: 'ğŸ“¢ Test Broadcast',
    body: 'This is a test broadcast to all users!',
    data: {
      type: 'broadcast',
      timestamp: new Date().toISOString()
    }
  };

  console.log('Sending to all users...');
  console.log('Message:', customMessage, '\n');

  const result = await sendNotificationToAllUsers(customMessage);

  console.log('Result:', JSON.stringify(result, null, 2), '\n');

  if (result.success) {
    console.log(`âœ… Sent to ${result.totalUsers} users!`);
    console.log(`   Successful: ${result.sent}`);
    console.log(`   Failed: ${result.failed}`);
  } else {
    console.log('âŒ Failed to send notifications:', result.message || result.error);
  }
}

// Run tests
main().catch(error => {
  console.error('âŒ Test script error:', error);
  process.exit(1);
});
